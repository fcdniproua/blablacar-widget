<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlaBlaCar Widget</title>

<!-- –°—Ç–∏–ª—ñ –≤—ñ–¥–∂–µ—Ç–∞ —Ç–æ—á–Ω–æ —è–∫ –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—ñ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://ims.blablacar.pro/white-label/widget/assets/css/app.css" media="all">
<link rel="stylesheet" href="https://ims.blablacar.pro/white-label/widget/assets/print.css" media="print">

<style>
html, body {
    margin: 0;
    padding: 0;
    height: auto;
    min-height: 100vh;
    overflow-x: hidden;
    box-sizing: border-box;
}

#app {
    min-height: 800px;
    height: auto;
    width: 100%;
    overflow: visible;
    box-sizing: border-box;
}

/* –§—ñ–∫—Å –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–∂–µ—Ç–∞ */
.container, .container-fluid {
    height: auto !important;
    min-height: auto !important;
}

/* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω */
.modal, .popup, .overlay {
    position: fixed !important;
    z-index: 9999 !important;
}

/* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–æ–±–∫–∏ –ø–ª–∞—Ç–µ–∂—É */
.payment-processing {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #007bff;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 14px;
    z-index: 10000;
    display: none;
}

.payment-success {
    background: #28a745 !important;
}

.payment-error {
    background: #dc3545 !important;
}
</style>
</head>
<body>

<!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É -->
<div id="payment-status" class="payment-processing">
    <span id="payment-message">–û–±—Ä–æ–±–∫–∞ –ø–ª–∞—Ç–µ–∂—É...</span>
</div>

<!-- –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –±–ª–æ–∫ –≤—ñ–¥–∂–µ—Ç–∞ –±–µ–∑ –∑–º—ñ–Ω -->
<div id="app" 
     data-spa="1" 
     data-ptoken="f5059429-7229-40e7-a2c4-feb24471e21d" 
     data-lang="uk" 
     data-env="prod"></div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
let lastHeight = 0;
let heightCheckInterval;
let isWidgetLoaded = false;
let paymentInProgress = false;
let paymentStatusChecker = null;
let lastPaymentTimestamp = 0;

// GitHub Pages SPA fallback - –æ–±—Ä–æ–±–∫–∞ URL –∑ hash
function handleGitHubPagesSPA() {
    const hash = window.location.hash;
    const pathname = window.location.pathname;
    
    console.log('Current URL:', window.location.href);
    console.log('Hash:', hash);
    console.log('Pathname:', pathname);
    
    // –Ø–∫—â–æ —î hash –∑ —Ä–æ—É—Ç–æ–º, –≤–∏—Ç—è–≥—É—î–º–æ –π–æ–≥–æ
    if (hash && hash.includes('/')) {
        const route = hash.substring(1); // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ #
        console.log('Extracted route from hash:', route);
        
        // –û–±—Ä–æ–±–ª—è—î–º–æ —Ä–æ—É—Ç
        if (route.includes('/buy/success')) {
            setTimeout(() => {
                handleRouteChange('success');
            }, 1000);
        } else if (route.includes('/buy/error')) {
            setTimeout(() => {
                handleRouteChange('error');
            }, 1000);
        } else if (route.includes('/checkout')) {
            setTimeout(() => {
                handleRouteChange('checkout');
            }, 1000);
        } else if (route.includes('/search')) {
            setTimeout(() => {
                handleRouteChange('search');
            }, 1000);
        }
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–æ—É—Ç—É –≤—ñ–¥–∂–µ—Ç–∞
function getCurrentRoute() {
    const url = window.location.href;
    const path = window.location.pathname;
    const hash = window.location.hash;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—Å—ñ –º–æ–∂–ª–∏–≤—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ —Ä–æ—É—Ç—ñ–≤
    if (url.includes('/search') || path.includes('/search') || hash.includes('search')) {
        return 'search';
    }
    if (url.includes('/checkout') || path.includes('/checkout') || hash.includes('checkout')) {
        return 'checkout';
    }
    if (url.includes('/buy/success') || path.includes('/buy/success') || hash.includes('success') || hash.includes('/buy/success')) {
        return 'success';
    }
    if (url.includes('/buy/error') || path.includes('/buy/error') || hash.includes('error') || hash.includes('/buy/error')) {
        return 'error';
    }
    
    return 'home';
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É
function showPaymentStatus(message, type = 'processing') {
    const statusEl = document.getElementById('payment-status');
    const messageEl = document.getElementById('payment-message');
    
    if (statusEl && messageEl) {
        messageEl.textContent = message;
        statusEl.className = 'payment-processing';
        
        if (type === 'success') {
            statusEl.classList.add('payment-success');
        } else if (type === 'error') {
            statusEl.classList.add('payment-error');
        }
        
        statusEl.style.display = 'block';
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è success/error
        if (type !== 'processing') {
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 10000);
        }
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É
function hidePaymentStatus() {
    const statusEl = document.getElementById('payment-status');
    if (statusEl) {
        statusEl.style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É –≤ localStorage
function savePaymentStatus(status, data = {}) {
    try {
        localStorage.setItem('blablacar_payment_status', JSON.stringify({
            status: status,
            timestamp: Date.now(),
            data: data,
            url: window.location.href
        }));
    } catch (error) {
        console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂—É:', error);
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É –∑ localStorage
function getPaymentStatus() {
    try {
        const stored = localStorage.getItem('blablacar_payment_status');
        if (stored) {
            const parsed = JSON.parse(stored);
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–µ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π —Å—Ç–∞—Ç—É—Å (–±—ñ–ª—å—à–µ 10 —Ö–≤–∏–ª–∏–Ω)
            if (Date.now() - parsed.timestamp < 600000) {
                return parsed;
            } else {
                localStorage.removeItem('blablacar_payment_status');
            }
        }
    } catch (error) {
        console.warn('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É:', error);
    }
    return null;
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É
function clearPaymentStatus() {
    try {
        localStorage.removeItem('blablacar_payment_status');
    } catch (error) {
        console.warn('–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É:', error);
    }
}

// –î–µ—Ç–µ–∫—Ü—ñ—è –ø–æ—á–∞—Ç–∫—É –ø—Ä–æ—Ü–µ—Å—É –æ–ø–ª–∞—Ç–∏
function detectPaymentStart() {
    // –í—ñ–¥—Å—Ç–µ–∂—É—î–º–æ –∫–ª—ñ–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞—Ö –æ–ø–ª–∞—Ç–∏
    document.addEventListener('click', function(event) {
        const target = event.target;
        const isPaymentButton = target && (
            target.textContent && (
                target.textContent.includes('–û–ø–ª–∞—Ç–∏—Ç–∏') ||
                target.textContent.includes('–ö—É–ø–∏—Ç–∏') ||
                target.textContent.includes('–ó–∞–º–æ–≤–∏—Ç–∏') ||
                target.textContent.includes('Pay') ||
                target.textContent.includes('Buy')
            ) ||
            target.className && (
                target.className.includes('pay') ||
                target.className.includes('buy') ||
                target.className.includes('checkout')
            ) ||
            target.closest('[class*="pay"]') ||
            target.closest('[class*="buy"]') ||
            target.closest('[class*="checkout"]')
        );
        
        if (isPaymentButton) {
            console.log('üîÑ –í–∏—è–≤–ª–µ–Ω–æ –ø–æ—á–∞—Ç–æ–∫ –ø—Ä–æ—Ü–µ—Å—É –æ–ø–ª–∞—Ç–∏');
            paymentInProgress = true;
            lastPaymentTimestamp = Date.now();
            savePaymentStatus('processing', { startTime: lastPaymentTimestamp });
            showPaymentStatus('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–ª–∞—Ç–µ–∂—É...', 'processing');
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å—É
            startPaymentStatusMonitoring();
        }
    }, true);
}

// –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É
function startPaymentStatusMonitoring() {
    if (paymentStatusChecker) {
        clearInterval(paymentStatusChecker);
    }
    
    let checkCount = 0;
    const maxChecks = 120; // 10 —Ö–≤–∏–ª–∏–Ω –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
    
    showPaymentStatus('–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É 3DS...', 'processing');
    
    paymentStatusChecker = setInterval(() => {
        checkCount++;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–º—ñ–Ω–∏ –≤ URL
        const currentRoute = getCurrentRoute();
        
        if (currentRoute === 'success') {
            console.log('‚úÖ –ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–∏–π (–≤–∏—è–≤–ª–µ–Ω–æ –ø–æ URL)');
            handlePaymentSuccess({ source: 'url_detection', route: currentRoute });
            clearInterval(paymentStatusChecker);
            return;
        }
        
        if (currentRoute === 'error') {
            console.log('‚ùå –ü–ª–∞—Ç—ñ–∂ –Ω–µ—É—Å–ø—ñ—à–Ω–∏–π (–≤–∏—è–≤–ª–µ–Ω–æ –ø–æ URL)');
            handlePaymentError({ source: 'url_detection', route: currentRoute });
            clearInterval(paymentStatusChecker);
            return;
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —É—Å–ø—ñ—Ö—É/–ø–æ–º–∏–ª–∫–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
        const successElements = document.querySelectorAll('[class*="success"], [class*="complete"], [class*="paid"]');
        const errorElements = document.querySelectorAll('[class*="error"], [class*="fail"], [class*="declined"]');
        
        if (successElements.length > 0) {
            console.log('‚úÖ –ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–∏–π (–≤–∏—è–≤–ª–µ–Ω–æ –ø–æ –µ–ª–µ–º–µ–Ω—Ç–∞–º DOM)');
            handlePaymentSuccess({ source: 'dom_detection', elements: successElements.length });
            clearInterval(paymentStatusChecker);
            return;
        }
        
        if (errorElements.length > 0) {
            console.log('‚ùå –ü–ª–∞—Ç—ñ–∂ –Ω–µ—É—Å–ø—ñ—à–Ω–∏–π (–≤–∏—è–≤–ª–µ–Ω–æ –ø–æ –µ–ª–µ–º–µ–Ω—Ç–∞–º DOM)');
            handlePaymentError({ source: 'dom_detection', elements: errorElements.length });
            clearInterval(paymentStatusChecker);
            return;
        }
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
        if (checkCount % 60 === 0) {
            const minutes = Math.floor(checkCount / 60);
            showPaymentStatus(`–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É... (${minutes} —Ö–≤)`, 'processing');
        }
        
        // –ó—É–ø–∏–Ω—è—î–º–æ –ø—ñ—Å–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
        if (checkCount >= maxChecks) {
            console.log('‚è∞ –¢–∞–π–º-–∞—É—Ç –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –ø–ª–∞—Ç–µ–∂—É');
            showPaymentStatus('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–∞—à—É —ñ—Å—Ç–æ—Ä—ñ—é –∑–∞–º–æ–≤–ª–µ–Ω—å.', 'error');
            paymentInProgress = false;
            clearInterval(paymentStatusChecker);
        }
    }, 5000); // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
}

// –û–±—Ä–æ–±–∫–∞ —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂—É
function handlePaymentSuccess(data = {}) {
    console.log('‚úÖ –£—Å–ø—ñ—à–Ω–∏–π –ø–ª–∞—Ç—ñ–∂ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è:', data);
    
    paymentInProgress = false;
    savePaymentStatus('success', data);
    showPaymentStatus('‚úÖ –ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');
    
    // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–µ –≤—ñ–∫–Ω–æ
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({
            type: 'payment_success',
            data: { ...data, timestamp: Date.now(), url: window.location.href },
            source: 'blablacar-widget'
        }, '*');
    }
    
    // –û—á–∏—â—É—î–º–æ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        clearPaymentStatus();
    }, 5000);
}

// –û–±—Ä–æ–±–∫–∞ –Ω–µ—É—Å–ø—ñ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂—É
function handlePaymentError(data = {}) {
    console.log('‚ùå –ù–µ—É—Å–ø—ñ—à–Ω–∏–π –ø–ª–∞—Ç—ñ–∂ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è:', data);
    
    paymentInProgress = false;
    savePaymentStatus('error', data);
    showPaymentStatus('‚ùå –ü–ª–∞—Ç—ñ–∂ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.', 'error');
    
    // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–µ –≤—ñ–∫–Ω–æ
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({
            type: 'payment_error',
            data: { ...data, timestamp: Date.now(), url: window.location.href },
            source: 'blablacar-widget'
        }, '*');
    }
    
    // –û—á–∏—â—É—î–º–æ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        clearPaymentStatus();
    }, 5000);
}

// –û–±—Ä–æ–±–∫–∞ —Ñ–æ–∫—É—Å—É –≤—ñ–∫–Ω–∞ (–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ 3DS)
function handleWindowFocus() {
    window.addEventListener('focus', function() {
        if (paymentInProgress) {
            console.log('üîç –í—ñ–∫–Ω–æ –æ—Ç—Ä–∏–º–∞–ª–æ —Ñ–æ–∫—É—Å –ø—ñ–¥ —á–∞—Å –ø–ª–∞—Ç–µ–∂—É - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å');
            
            // –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É –ø—ñ—Å–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
            setTimeout(() => {
                const currentRoute = getCurrentRoute();
                
                if (currentRoute === 'success') {
                    handlePaymentSuccess({ source: 'window_focus', route: currentRoute });
                } else if (currentRoute === 'error') {
                    handlePaymentError({ source: 'window_focus', route: currentRoute });
                } else {
                    // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
                    showPaymentStatus('–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–ª–∞—Ç–µ–∂—É...', 'processing');
                }
            }, 2000);
        }
    });
}

// –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤–∏—Å–æ—Ç–∏ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–º—É –≤—ñ–∫–Ω—É
function sendHeightToParent() {
    try {
        // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –º–æ–∂–ª–∏–≤—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –≤–∏—Å–æ—Ç–∏
        const bodyHeight = document.body.scrollHeight;
        const bodyOffsetHeight = document.body.offsetHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const documentOffsetHeight = document.documentElement.offsetHeight;
        const appElement = document.getElementById('app');
        const appHeight = appElement ? Math.max(appElement.scrollHeight, appElement.offsetHeight) : 0;
        const windowHeight = window.innerHeight;
        
        // –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
        const allElements = document.querySelectorAll('*');
        let maxElementBottom = 0;
        
        allElements.forEach(el => {
            const rect = el.getBoundingClientRect();
            const elementBottom = rect.bottom + window.pageYOffset;
            if (elementBottom > maxElementBottom) {
                maxElementBottom = elementBottom;
            }
        });
        
        // –í–∏–±–∏—Ä–∞—î–º–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É –≤–∏—Å–æ—Ç—É –∑ —É—Å—ñ—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤
        const calculatedHeight = Math.max(
            bodyHeight,
            bodyOffsetHeight,
            documentHeight,
            documentOffsetHeight,
            appHeight,
            windowHeight,
            maxElementBottom
        );
        
        // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–∏—Å–æ—Ç–∞ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–æ—É—Ç—É
        const currentRoute = getCurrentRoute();
        let minHeight = 400;
        
        switch(currentRoute) {
            case 'search': minHeight = 500; break;
            case 'checkout': minHeight = 600; break;
            case 'success': minHeight = 350; break;
            case 'error': minHeight = 350; break;
            default: minHeight = 400; break;
        }
        
        const finalHeight = Math.max(calculatedHeight, minHeight);
        
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤–∏—Å–æ—Ç—É —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≤–æ–Ω–∞ –∑–º—ñ–Ω–∏–ª–∞—Å—å –∑–Ω–∞—á–Ω–æ
        if (Math.abs(finalHeight - lastHeight) > 10 || !isWidgetLoaded) {
            lastHeight = finalHeight;
            isWidgetLoaded = true;
            
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'iframeResize',
                    iframeHeight: finalHeight,
                    route: currentRoute,
                    source: 'blablacar-widget'
                }, '*');
            }
            
            console.log(`–í–∏—Å–æ—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞: ${finalHeight}px, –†–æ—É—Ç: ${currentRoute}`);
        }
        
    } catch (error) {
        console.warn('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –≤–∏—Å–æ—Ç–∏:', error);
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω —Ä–æ—É—Ç—É
function trackRouteChanges() {
    let currentRoute = getCurrentRoute();
    
    // –û–±—Ä–æ–±–ª—è—î–º–æ popstate –ø–æ–¥—ñ—ó (–∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥)
    window.addEventListener('popstate', () => {
        setTimeout(() => {
            const newRoute = getCurrentRoute();
            if (newRoute !== currentRoute) {
                currentRoute = newRoute;
                handleRouteChange(newRoute);
            }
        }, 100);
    });
    
    // –û–±—Ä–æ–±–ª—è—î–º–æ –∑–º—ñ–Ω–∏ hash
    window.addEventListener('hashchange', () => {
        setTimeout(() => {
            handleGitHubPagesSPA();
            const newRoute = getCurrentRoute();
            if (newRoute !== currentRoute) {
                currentRoute = newRoute;
                handleRouteChange(newRoute);
            }
        }, 100);
    });
    
    // –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–º—ñ–Ω–∏ —Ä–æ—É—Ç—É
    setInterval(() => {
        const newRoute = getCurrentRoute();
        if (newRoute !== currentRoute) {
            currentRoute = newRoute;
            handleRouteChange(newRoute);
        }
    }, 1000);
}

// –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω–∏ —Ä–æ—É—Ç—É
function handleRouteChange(route) {
    console.log('–ó–º—ñ–Ω–∞ —Ä–æ—É—Ç—É –Ω–∞:', route);
    
    // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–µ –≤—ñ–∫–Ω–æ –ø—Ä–æ –∑–º—ñ–Ω—É —Ä–æ—É—Ç—É  
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({
            type: 'routeChange',
            route: route,
            url: window.location.href,
            source: 'blablacar-widget'
        }, '*');
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏—Å–æ—Ç—É –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ —Ä–æ—É—Ç—É
    setTimeout(sendHeightToParent, 200);
    setTimeout(sendHeightToParent, 1000);
    setTimeout(sendHeightToParent, 2000);
    
    // –û–±—Ä–æ–±–ª—è—î–º–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Ä–æ—É—Ç–∏
    if (route === 'success') {
        handlePaymentSuccess({ route: 'success', source: 'route_change' });
    }
    
    if (route === 'error') {
        handlePaymentError({ route: 'error', source: 'route_change' });
    }
}

// –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á –∑–∞ –∑–º—ñ–Ω–∞–º–∏ DOM
const observer = new MutationObserver((mutations) => {
    let shouldUpdate = false;
    
    mutations.forEach((mutation) => {
        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
            shouldUpdate = true;
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —Å—Ç–∞—Ç—É—Å—É –ø–ª–∞—Ç–µ–∂—É
            mutation.addedNodes.forEach(node => {
                if (node.nodeType === 1) { // Element node
                    const text = node.textContent || '';
                    const className = node.className || '';
                    
                    if (paymentInProgress) {
                        // –î–µ—Ç–µ–∫—Ü—ñ—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂—É
                        if (text.includes('—É—Å–ø—ñ—à–Ω–æ') || text.includes('–æ–ø–ª–∞—á–µ–Ω–æ') || text.includes('success') ||
                            className.includes('success') || className.includes('complete')) {
                            handlePaymentSuccess({ source: 'dom_mutation', text: text.substring(0, 100) });
                        }
                        
                        // –î–µ—Ç–µ–∫—Ü—ñ—è –ø–æ–º–∏–ª–∫–∏ –ø–ª–∞—Ç–µ–∂—É
                        if (text.includes('–ø–æ–º–∏–ª–∫–∞') || text.includes('error') || text.includes('–≤—ñ–¥—Ö–∏–ª–µ–Ω–æ') ||
                            className.includes('error') || className.includes('fail')) {
                            handlePaymentError({ source: 'dom_mutation', text: text.substring(0, 100) });
                        }
                    }
                }
            });
        } else if (mutation.type === 'attributes' && 
                  ['style', 'class', 'height'].includes(mutation.attributeName)) {
            shouldUpdate = true;
        }
    });
    
    if (shouldUpdate) {
        setTimeout(sendHeightToParent, 100);
    }
});

// –û–±—Ä–æ–±–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ —Å–∞–º–æ–≥–æ –≤—ñ–¥–∂–µ—Ç–∞ BlaBlaCar —Ç–∞ LiqPay
window.addEventListener('message', function(event) {
    try {
        if (event.data && typeof event.data === 'object') {
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä—ñ–∑–Ω—ñ —Ç–∏–ø–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ –≤—ñ–¥–∂–µ—Ç–∞
            const data = event.data;
            
            // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω—É –æ–ø–ª–∞—Ç—É
            if (data.type === 'payment_complete' || 
                data.type === 'purchase_success' ||
                data.status === 'success' ||
                data.event === 'payment_success' ||
                data.action === 'payment_success' ||
                (data.liqpay && data.liqpay.status === 'success')) {
                
                console.log('–û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω—É –æ–ø–ª–∞—Ç—É:', data);
                handlePaymentSuccess({ source: 'postmessage', data: data });
            }
            
            // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É –æ–ø–ª–∞—Ç–∏
            if (data.type === 'payment_error' || 
                data.type === 'purchase_error' ||
                data.status === 'error' ||
                data.event === 'payment_error' ||
                data.action === 'payment_error' ||
                (data.liqpay && data.liqpay.status === 'error')) {
                
                console.log('–û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É –æ–ø–ª–∞—Ç–∏:', data);
                handlePaymentError({ source: 'postmessage', data: data });
            }
            
            // LiqPay —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            if (data.liqpay) {
                console.log('LiqPay –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', data);
                
                if (data.liqpay.action === '3ds_verify') {
                    showPaymentStatus('–ü—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è 3DS –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏...', 'processing');
                }
            }
            
            // –ë—É–¥—å-—è–∫—ñ —ñ–Ω—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –≤—ñ–¥–∂–µ—Ç–∞
            if (data.type && !data.source) {
                console.log('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –≤—ñ–¥–∂–µ—Ç–∞:', data);
                setTimeout(sendHeightToParent, 200);
            }
        }
    } catch (error) {
        console.warn('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', error);
    }
});

// –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
window.addEventListener('error', function(event) {
    console.warn('–ü–æ–º–∏–ª–∫–∞:', event.error);
    
    // –ë–∞–∑–æ–≤–∞ –æ–±—Ä–æ–±–∫–∞ 404 –ø–æ–º–∏–ª–æ–∫
    if (event.message && (
        event.message.includes('404') || 
        event.message.includes('Not Found') ||
        event.message.includes('Cannot GET')
    )) {
        console.error('–í–∏—è–≤–ª–µ–Ω–æ 404 –ø–æ–º–∏–ª–∫—É:', event.message);
        
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({
                type: 'navigation_error',
                error: '404',
                url: window.location.href,
                message: event.message,
                source: 'blablacar-widget'
            }, '*');
        }
    }
});

// –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–∏—Ö –ø—Ä–æ–º—ñ—Å—ñ–≤
window.addEventListener('unhandledrejection', function(event) {
    console.warn('–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π –ø—Ä–æ–º—ñ—Å:', event.reason);
    
    const error = event.reason;
    if (error && (
        (typeof error === 'string' && error.includes('404')) ||
        (error.message && error.message.includes('404')) ||
        (error.status === 404)
    )) {
        console.error('404 –≤ –ø—Ä–æ–º—ñ—Å—ñ:', error);
        
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({
                type: 'promise_rejection_404',
                error: error.toString(),
                url: window.location.href,
                source: 'blablacar-widget'
            }, '*');
        }
        
        event.preventDefault();
    }
});

// –§—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
function initializeWidget() {
    console.log('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è BlaBlaCar –≤—ñ–¥–∂–µ—Ç–∞...');
    console.log('–ü–æ—Ç–æ—á–Ω–∏–π URL:', window.location.href);
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂—É
    const savedStatus = getPaymentStatus();
    if (savedStatus) {
        console.log('–ó–Ω–∞–π–¥–µ–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂—É:', savedStatus);
        
        if (savedStatus.status === 'processing') {
            paymentInProgress = true;
            lastPaymentTimestamp = savedStatus.timestamp;
            startPaymentStatusMonitoring();
        } else if (savedStatus.status === 'success') {
            showPaymentStatus('‚úÖ –û—Å—Ç–∞–Ω–Ω—ñ–π –ø–ª–∞—Ç—ñ–∂ –±—É–≤ —É—Å–ø—ñ—à–Ω–∏–º', 'success');
        } else if (savedStatus.status === 'error') {
            showPaymentStatus('‚ùå –û—Å—Ç–∞–Ω–Ω—ñ–π –ø–ª–∞—Ç—ñ–∂ –Ω–µ –≤–¥–∞–≤—Å—è', 'error');
        }
    }
    
    // –û–±—Ä–æ–±–ª—è—î–º–æ GitHub Pages SPA routing
    handleGitHubPagesSPA();
    
    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω —Ä–æ—É—Ç—É
    trackRouteChanges();
    
    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–µ—Ç–µ–∫—Ü—ñ—é –ø–æ—á–∞—Ç–∫—É –ø–ª–∞—Ç–µ–∂—É
    detectPaymentStart();
    
    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ–±—Ä–æ–±–∫—É —Ñ–æ–∫—É—Å—É –≤—ñ–∫–Ω–∞
    handleWindowFocus();
    
    // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á DOM
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class', 'height']
    });
    
    // –Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏—Å–æ—Ç–∏ –ø–µ—Ä—à—ñ 20 —Å–µ–∫—É–Ω–¥
    let checkCount = 0;
    const maxChecks = 40; // 20 —Å–µ–∫—É–Ω–¥ –ø–æ 500–º—Å
    
    heightCheckInterval = setInterval(() => {
        sendHeightToParent();
        checkCount++;
        
        if (checkCount >= maxChecks) {
            clearInterval(heightCheckInterval);
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ —Ä—ñ–¥—à—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏
            setInterval(sendHeightToParent, 3000);
        }
    }, 500);
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–æ—É—Ç
    setTimeout(() => {
        handleRouteChange(getCurrentRoute());
    }, 1000);
}

// –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
window.addEventListener('load', function() {
    setTimeout(initializeWidget, 500);
});

window.addEventListener('resize', function() {
    setTimeout(sendHeightToParent, 100);
});

// –Ø–∫—â–æ DOM –≤–∂–µ –≥–æ—Ç–æ–≤–∏–π
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeWidget, 200);
    });
} else {
    setTimeout(initializeWidget, 200);
}

// –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—É –≤–∏—Å–æ—Ç—É
setTimeout(sendHeightToParent, 1000);
setTimeout(sendHeightToParent, 3000);
</script>

<!-- –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ —Å–∫—Ä–∏–ø—Ç–∏ –≤—ñ–¥–∂–µ—Ç–∞ –±–µ–∑ –∑–º—ñ–Ω -->
<script src="https://ims.blablacar.pro/white-label/widget/assets/js/manifest.js"></script>
<script src="https://ims.blablacar.pro/white-label/widget/assets/js/vendor.js"></script>
<script src="https://ims.blablacar.pro/white-label/widget/assets/js/app.js"></script>

</body>
</html> 